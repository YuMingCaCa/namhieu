<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Vận Tải</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 50;
        }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        .table-container { max-height: 65vh; overflow-y: auto; }

        /* Tab styles */
        .tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: #4b5563; /* gray-600 */
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            border-bottom-color: #2563eb; /* blue-600 */
            color: #1d4ed8; /* blue-700 */
            font-weight: 600;
        }
        .tab-btn:disabled {
            color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
        }
        .currency-input::-webkit-inner-spin-button, 
        .currency-input::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .currency-input {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app" class="p-4 sm:p-6 lg:p-8">
        <div class="max-w-screen-xl mx-auto">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Hệ Thống Quản Lý Vận Tải</h1>
                    <p class="mt-1 text-sm text-gray-600">Quản lý toàn diện: Chuyến hàng, Đối tác, Đội xe và Tài chính.</p>
                </div>
                 <div class="text-sm text-gray-600 mt-2 sm:mt-0">
                    User ID: <span id="userId" class="font-mono bg-gray-200 px-2 py-1 rounded"></span>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                    <button class="tab-btn active" data-tab="trips">Quản Lý Chuyến</button>
                    <button class="tab-btn" data-tab="finance">Tổng Quan Tài Chính</button>
                    <button class="tab-btn" data-tab="customers">Khách Hàng</button>
                    <button class="tab-btn" data-tab="drivers">Tài Xế</button>
                    <button class="tab-btn" data-tab="tractors">Đầu Kéo</button>
                    <button class="tab-btn" data-tab="trailers">Rơ-moóc</button>
                </nav>
            </div>

            <!-- Main Content Area -->
            <main>
                <!-- Trips View -->
                <div id="trips-view" class="tab-content">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Danh Sách Chuyến Hàng</h2>
                        <button id="add-trip-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">+ Thêm Chuyến Mới</button>
                    </div>
                    <input type="text" id="search-trips" placeholder="Tìm kiếm chuyến..." class="w-full sm:w-1/3 mb-4 p-2 border rounded-lg">
                    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                        <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số Cont</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Khách Hàng</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tuyến Đường</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Cước Phí</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Lợi Nhuận</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody id="trips-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Finance View -->
                <div id="finance-view" class="tab-content hidden">
                    <h2 class="text-xl font-semibold mb-4">Tổng Quan Tài Chính</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">Tổng Doanh Thu</h3>
                            <p id="total-revenue" class="mt-1 text-3xl font-semibold text-green-600">0 VNĐ</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">Tổng Chi Phí</h3>
                            <p id="total-expenses" class="mt-1 text-3xl font-semibold text-red-600">0 VNĐ</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">Tổng Lợi Nhuận</h3>
                            <p id="total-profit" class="mt-1 text-3xl font-semibold text-blue-600">0 VNĐ</p>
                        </div>
                    </div>
                </div>

                <!-- Customers View -->
                <div id="customers-view" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Danh Sách Khách Hàng</h2>
                        <button id="add-customer-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">+ Thêm Khách Hàng</button>
                    </div>
                    <input type="text" id="search-customers" placeholder="Tìm kiếm khách hàng..." class="w-full sm:w-1/3 mb-4 p-2 border rounded-lg">
                    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                        <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tên Khách Hàng</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Người Liên Hệ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SĐT</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody id="customers-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Drivers View -->
                <div id="drivers-view" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Danh Sách Tài Xế</h2>
                        <button id="add-driver-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">+ Thêm Tài Xế</button>
                    </div>
                    <input type="text" id="search-drivers" placeholder="Tìm kiếm tài xế..." class="w-full sm:w-1/3 mb-4 p-2 border rounded-lg">
                    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                        <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Họ Tên</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SĐT</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số GPLX</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody id="drivers-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tractors View -->
                <div id="tractors-view" class="tab-content hidden">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Danh Sách Đầu Kéo</h2>
                        <button id="add-tractor-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">+ Thêm Đầu Kéo</button>
                    </div>
                    <input type="text" id="search-tractors" placeholder="Tìm kiếm đầu kéo..." class="w-full sm:w-1/3 mb-4 p-2 border rounded-lg">
                    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                         <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Biển Số Xe</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loại Xe</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Đời Xe</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody id="tractors-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Trailers View -->
                <div id="trailers-view" class="tab-content hidden">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Danh Sách Rơ-moóc</h2>
                        <button id="add-trailer-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">+ Thêm Rơ-moóc</button>
                    </div>
                    <input type="text" id="search-trailers" placeholder="Tìm kiếm rơ-moóc..." class="w-full sm:w-1/3 mb-4 p-2 border rounded-lg">
                    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                         <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Biển Số Moóc</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loại Moóc</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody id="trailers-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Generic Modal for Add/Edit -->
    <div id="form-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 modal-content">
            <form id="modal-form" class="p-6">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-6">Modal Title</h2>
                <input type="hidden" id="edit-id">
                <input type="hidden" id="modal-type">
                <div id="modal-body">
                    <!-- Dynamic form fields will be injected here -->
                </div>
                <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
                    <button type="button" id="cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                    <button type="submit" id="save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirm-dialog" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 sm:w-1/3 p-6">
            <h3 class="text-lg font-bold">Xác nhận xóa</h3>
            <p class="my-4">Bạn có chắc chắn muốn xóa mục này không? Hành động này không thể hoàn tác.</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Xóa</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, getDoc, deleteDoc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- Config and Initialization ---
        // Your web app's Firebase configuration from your project
        const firebaseConfig = {
            apiKey: "AIzaSyDfEfoZ2T5p1f0xvj5MlQXmA_rPhMl9aok",
            authDomain: "vantainamhieu.firebaseapp.com",
            projectId: "vantainamhieu",
            storageBucket: "vantainamhieu.appspot.com", // Corrected from firebasestorage.app
            messagingSenderId: "1095529198244",
            appId: "1:1095529198244:web:e4841ca7d431598c55ec31",
            measurementId: "G-ZPDSZYB6YX"
        };

        let app, auth, db, userId;
        let tripsCol, customersCol, driversCol, tractorsCol, trailersCol;
        let unsubTrips, unsubCustomers, unsubDrivers, unsubTractors, unsubTrailers;
        let allCustomers = [], allDrivers = [], allTractors = [], allTrailers = [], allTrips = [];

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug');
        } catch (e) { console.error("Firebase initialization failed:", e); }

        // --- DOM Elements ---
        const userIdSpan = document.getElementById('userId');
        const modal = document.getElementById('form-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalForm = document.getElementById('modal-form');
        const editIdInput = document.getElementById('edit-id');
        const modalTypeInput = document.getElementById('modal-type');
        const confirmDialog = document.getElementById('confirm-dialog');

        // --- App State ---
        let deleteResolver = null;
        const currencyFormatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

        // --- UI / Tab Management ---
        const tabs = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            if (tab.disabled) return;
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const targetViewId = `${tab.dataset.tab}-view`;
                tabContents.forEach(content => {
                    if (content.id !== targetViewId && !content.classList.contains('hidden')) {
                        content.classList.add('hidden');
                    }
                });
                const targetView = document.getElementById(targetViewId);
                if (targetView) targetView.classList.remove('hidden');
            });
        });

        // --- Modal Management ---
        const openModal = async (type, isEditing = false, data = {}) => {
            modalForm.reset();
            modalTypeInput.value = type;
            editIdInput.value = isEditing ? data.id : '';
            
            let formHtml = '';
            let title = '';

            switch(type) {
                case 'trip':
                    title = isEditing ? 'Chỉnh Sửa Chuyến Hàng' : 'Thêm Chuyến Hàng Mới';
                    const customerOpts = allCustomers.map(c => `<option value="${c.id}" ${data.customerId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
                    const driverOpts = allDrivers.map(d => `<option value="${d.id}" ${data.driverId === d.id ? 'selected' : ''}>${d.name}</option>`).join('');
                    const tractorOpts = allTractors.map(t => `<option value="${t.id}" ${data.tractorId === t.id ? 'selected' : ''}>${t.licensePlate}</option>`).join('');
                    const trailerOpts = allTrailers.map(t => `<option value="${t.id}" ${data.trailerId === t.id ? 'selected' : ''}>${t.licensePlate}</option>`).join('');
                    
                    formHtml = `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-6 gap-y-4">
                            <!-- Left Column -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-medium text-gray-700 border-b pb-2">Thông Tin Chuyến Đi</h3>
                                <input type="text" name="soCont" placeholder="Số Container" class="p-2 border rounded-md w-full" value="${data.soCont || ''}" required>
                                <input type="text" name="tuyenDuong" placeholder="Tuyến đường (VD: HP - HN)" class="p-2 border rounded-md w-full" value="${data.tuyenDuong || ''}" required>
                                <select name="customerId" class="p-2 border rounded-md w-full" required><option value="">-- Chọn Khách Hàng --</option>${customerOpts}</select>
                                <select name="driverId" class="p-2 border rounded-md w-full" required><option value="">-- Chọn Tài Xế --</option>${driverOpts}</select>
                                <select name="tractorId" class="p-2 border rounded-md w-full" required><option value="">-- Chọn Đầu Kéo --</option>${tractorOpts}</select>
                                <select name="trailerId" class="p-2 border rounded-md w-full" required><option value="">-- Chọn Rơ-moóc --</option>${trailerOpts}</select>
                                <textarea name="ghiChu" placeholder="Ghi Chú Chuyến Đi" class="p-2 border rounded-md w-full" rows="3">${data.ghiChu || ''}</textarea>
                            </div>
                            <!-- Right Column -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-medium text-gray-700 border-b pb-2">Thông Tin Tài Chính</h3>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Cước xe nhận được</label>
                                    <input type="number" name="cuocXe" placeholder="0" class="currency-input p-2 border rounded-md w-full" value="${data.cuocXe || ''}" required>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Chi phí xăng dầu</label>
                                    <input type="number" name="chiPhiXangDau" placeholder="0" class="currency-input p-2 border rounded-md w-full" value="${data.chiPhiXangDau || ''}">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Chi phí vé cầu đường</label>
                                    <input type="number" name="chiPhiVe" placeholder="0" class="currency-input p-2 border rounded-md w-full" value="${data.chiPhiVe || ''}">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Lương lái xe</label>
                                    <input type="number" name="chiPhiLuong" placeholder="0" class="currency-input p-2 border rounded-md w-full" value="${data.chiPhiLuong || ''}">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Tiền ca xe / bến bãi</label>
                                    <input type="number" name="chiPhiCaXe" placeholder="0" class="currency-input p-2 border rounded-md w-full" value="${data.chiPhiCaXe || ''}">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Chi phí phát sinh</label>
                                    <input type="number" name="chiPhiPhatSinh" placeholder="0" class="currency-input p-2 border rounded-md w-full" value="${data.chiPhiPhatSinh || ''}">
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'customer':
                    title = isEditing ? 'Chỉnh Sửa Khách Hàng' : 'Thêm Khách Hàng';
                    formHtml = `
                        <div class="space-y-4">
                            <input type="text" name="name" placeholder="Tên Khách Hàng" class="p-2 border rounded-md w-full" value="${data.name || ''}" required>
                            <input type="text" name="contactPerson" placeholder="Người Liên Hệ" class="p-2 border rounded-md w-full" value="${data.contactPerson || ''}">
                            <input type="tel" name="phone" placeholder="Số Điện Thoại" class="p-2 border rounded-md w-full" value="${data.phone || ''}">
                            <input type="text" name="address" placeholder="Địa Chỉ" class="p-2 border rounded-md w-full" value="${data.address || ''}">
                        </div>
                    `;
                    break;
                case 'driver':
                    title = isEditing ? 'Chỉnh Sửa Tài Xế' : 'Thêm Tài Xế';
                    formHtml = `
                         <div class="space-y-4">
                            <input type="text" name="name" placeholder="Họ và Tên" class="p-2 border rounded-md w-full" value="${data.name || ''}" required>
                            <input type="tel" name="phone" placeholder="Số Điện Thoại" class="p-2 border rounded-md w-full" value="${data.phone || ''}">
                            <input type="text" name="licenseNumber" placeholder="Số Giấy Phép Lái Xe" class="p-2 border rounded-md w-full" value="${data.licenseNumber || ''}">
                        </div>
                    `;
                    break;
                case 'tractor':
                    title = isEditing ? 'Chỉnh Sửa Đầu Kéo' : 'Thêm Đầu Kéo';
                    formHtml = `
                         <div class="space-y-4">
                            <input type="text" name="licensePlate" placeholder="Biển Số Xe" class="p-2 border rounded-md w-full" value="${data.licensePlate || ''}" required>
                            <input type="text" name="type" placeholder="Loại Xe (VD: Howo)" class="p-2 border rounded-md w-full" value="${data.type || ''}">
                            <input type="text" name="modelYear" placeholder="Đời Xe (VD: 2020)" class="p-2 border rounded-md w-full" value="${data.modelYear || ''}">
                        </div>
                    `;
                    break;
                case 'trailer':
                    title = isEditing ? 'Chỉnh Sửa Rơ-moóc' : 'Thêm Rơ-moóc';
                    formHtml = `
                         <div class="space-y-4">
                            <input type="text" name="licensePlate" placeholder="Biển Số Moóc" class="p-2 border rounded-md w-full" value="${data.licensePlate || ''}" required>
                            <input type="text" name="type" placeholder="Loại Moóc (VD: Moóc xương 40ft)" class="p-2 border rounded-md w-full" value="${data.type || ''}">
                        </div>
                    `;
                    break;
            }

            modalTitle.textContent = title;
            modalBody.innerHTML = formHtml;
            modal.classList.remove('hidden');
        };

        const closeModal = () => modal.classList.add('hidden');
        const showConfirmDialog = () => {
            confirmDialog.classList.remove('hidden');
            return new Promise(resolve => { deleteResolver = resolve; });
        };
        const hideConfirmDialog = () => {
            confirmDialog.classList.add('hidden');
            deleteResolver = null;
        };

        // --- Data Rendering ---
        const renderTable = (tbody, data, renderFn, filterTerm = '') => {
            const searchTerm = filterTerm.toLowerCase();
            const filteredData = data.filter(item => {
                if (!searchTerm) return true;
                const customer = allCustomers.find(c => c.id === item.customerId);
                return Object.values(item).some(val => 
                    typeof val === 'string' && val.toLowerCase().includes(searchTerm)
                ) || (customer && customer.name.toLowerCase().includes(searchTerm));
            });

            tbody.innerHTML = '';
            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center p-8 text-gray-500">Không có dữ liệu.</td></tr>`;
                return;
            }
            filteredData.forEach((item, index) => {
                tbody.appendChild(renderFn(item, index));
            });
        };

        const createTripRow = (item, index) => {
            const row = document.createElement('tr');
            row.className = "hover:bg-gray-50";
            const customer = allCustomers.find(c => c.id === item.customerId);
            
            const revenue = parseFloat(item.cuocXe) || 0;
            const expenses = (parseFloat(item.chiPhiXangDau) || 0) +
                             (parseFloat(item.chiPhiVe) || 0) +
                             (parseFloat(item.chiPhiLuong) || 0) +
                             (parseFloat(item.chiPhiCaXe) || 0) +
                             (parseFloat(item.chiPhiPhatSinh) || 0);
            const profit = revenue - expenses;

            row.innerHTML = `
                <td class="px-4 py-4 text-sm font-medium text-gray-900">${index + 1}</td>
                <td class="px-4 py-4 text-sm text-gray-700">${item.soCont || ''}</td>
                <td class="px-4 py-4 text-sm text-gray-700 font-semibold">${customer?.name || 'N/A'}</td>
                <td class="px-4 py-4 text-sm text-gray-500">${item.tuyenDuong || ''}</td>
                <td class="px-4 py-4 text-sm text-green-600 font-medium text-right">${currencyFormatter.format(revenue)}</td>
                <td class="px-4 py-4 text-sm ${profit >= 0 ? 'text-blue-600' : 'text-red-600'} font-bold text-right">${currencyFormatter.format(profit)}</td>
                <td class="px-4 py-4 text-center text-sm font-medium">
                    <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-type="trip" data-id="${item.id}">Sửa</button>
                    <button class="delete-btn text-red-600 hover:text-red-900 ml-4" data-type="trip" data-id="${item.id}">Xóa</button>
                </td>
            `;
            return row;
        };
        
        const createRow = (item, index, type) => {
             const row = document.createElement('tr');
             row.className = "hover:bg-gray-50";
             let content = '';
             switch(type) {
                case 'customer':
                    content = `
                        <td class="px-4 py-4 text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-4 py-4 text-sm text-gray-700 font-semibold">${item.name || ''}</td>
                        <td class="px-4 py-4 text-sm text-gray-500">${item.contactPerson || ''}</td>
                        <td class="px-4 py-4 text-sm text-gray-500">${item.phone || ''}</td>
                    `;
                    break;
                case 'driver':
                    content = `
                        <td class="px-4 py-4 text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-4 py-4 text-sm text-gray-700 font-semibold">${item.name || ''}</td>
                        <td class="px-4 py-4 text-sm text-gray-500">${item.phone || ''}</td>
                        <td class="px-4 py-4 text-sm text-gray-500">${item.licenseNumber || ''}</td>
                    `;
                    break;
                 case 'tractor':
                    content = `
                        <td class="px-4 py-4 text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-4 py-4 text-sm text-gray-700 font-semibold">${item.licensePlate || ''}</td>
                        <td class="px-4 py-4 text-sm text-gray-500">${item.type || ''}</td>
                        <td class="px-4 py-4 text-sm text-gray-500">${item.modelYear || ''}</td>
                    `;
                    break;
                case 'trailer':
                    content = `
                        <td class="px-4 py-4 text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-4 py-4 text-sm text-gray-700 font-semibold">${item.licensePlate || ''}</td>
                        <td class="px-4 py-4 text-sm text-gray-500">${item.type || ''}</td>
                    `;
                    break;
             }
             row.innerHTML = content + `
                <td class="px-4 py-4 text-right text-sm font-medium">
                    <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-type="${type}" data-id="${item.id}">Sửa</button>
                    <button class="delete-btn text-red-600 hover:text-red-900 ml-4" data-type="${type}" data-id="${item.id}">Xóa</button>
                </td>
             `;
             return row;
        }

        const updateFinanceDashboard = (trips) => {
            let totalRevenue = 0;
            let totalExpenses = 0;

            trips.forEach(trip => {
                const revenue = parseFloat(trip.cuocXe) || 0;
                const expenses = (parseFloat(trip.chiPhiXangDau) || 0) +
                                 (parseFloat(trip.chiPhiVe) || 0) +
                                 (parseFloat(trip.chiPhiLuong) || 0) +
                                 (parseFloat(trip.chiPhiCaXe) || 0) +
                                 (parseFloat(trip.chiPhiPhatSinh) || 0);
                totalRevenue += revenue;
                totalExpenses += expenses;
            });
            
            const totalProfit = totalRevenue - totalExpenses;

            document.getElementById('total-revenue').textContent = currencyFormatter.format(totalRevenue);
            document.getElementById('total-expenses').textContent = currencyFormatter.format(totalExpenses);
            document.getElementById('total-profit').textContent = currencyFormatter.format(totalProfit);
        };

        // --- Firestore Logic ---
        const setupFirestoreListeners = () => {
            // Path is now shared, not user-specific
            const basePath = 'vantai_data/nam_hieu_company';
            
            const collections = {
                trips: collection(db, `${basePath}/trips`),
                customers: collection(db, `${basePath}/customers`),
                drivers: collection(db, `${basePath}/drivers`),
                tractors: collection(db, `${basePath}/tractors`),
                trailers: collection(db, `${basePath}/trailers`),
            };
            tripsCol = collections.trips;
            customersCol = collections.customers;
            driversCol = collections.drivers;
            tractorsCol = collections.tractors;
            trailersCol = collections.trailers;

            if (unsubTrips) unsubTrips();
            if (unsubCustomers) unsubCustomers();
            if (unsubDrivers) unsubDrivers();
            if (unsubTractors) unsubTractors();
            if (unsubTrailers) unsubTrailers();

            const createListener = (col, stateArray, tbody, renderFn, searchInput) => {
                return onSnapshot(query(col), snapshot => {
                    stateArray.length = 0;
                    snapshot.docs.forEach(doc => stateArray.push({ id: doc.id, ...doc.data() }));
                    renderTable(tbody, stateArray, renderFn, searchInput.value);
                }, error => console.error(`Error listening to ${col.path}:`, error));
            };

            unsubCustomers = createListener(customersCol, allCustomers, document.getElementById('customers-table-body'), (item, index) => createRow(item, index, 'customer'), document.getElementById('search-customers'));
            unsubDrivers = createListener(driversCol, allDrivers, document.getElementById('drivers-table-body'), (item, index) => createRow(item, index, 'driver'), document.getElementById('search-drivers'));
            unsubTractors = createListener(tractorsCol, allTractors, document.getElementById('tractors-table-body'), (item, index) => createRow(item, index, 'tractor'), document.getElementById('search-tractors'));
            unsubTrailers = createListener(trailersCol, allTrailers, document.getElementById('trailers-table-body'), (item, index) => createRow(item, index, 'trailer'), document.getElementById('search-trailers'));
            
            unsubTrips = onSnapshot(query(tripsCol), snapshot => {
                allTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTable(document.getElementById('trips-table-body'), allTrips, createTripRow, document.getElementById('search-trips').value);
                updateFinanceDashboard(allTrips);
            }, error => console.error(`Error listening to trips:`, error));
        };

        // --- Event Listeners ---
        document.getElementById('add-trip-btn').addEventListener('click', () => openModal('trip'));
        document.getElementById('add-customer-btn').addEventListener('click', () => openModal('customer'));
        document.getElementById('add-driver-btn').addEventListener('click', () => openModal('driver'));
        document.getElementById('add-tractor-btn').addEventListener('click', () => openModal('tractor'));
        document.getElementById('add-trailer-btn').addEventListener('click', () => openModal('trailer'));
        
        document.getElementById('cancel-btn').addEventListener('click', closeModal);
        document.getElementById('confirm-cancel-btn').addEventListener('click', () => { if (deleteResolver) deleteResolver(false); hideConfirmDialog(); });
        document.getElementById('confirm-delete-btn').addEventListener('click', () => { if (deleteResolver) deleteResolver(true); hideConfirmDialog(); });
        modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

        modalForm.addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(modalForm);
            const data = Object.fromEntries(formData.entries());
            const type = modalTypeInput.value;
            const id = editIdInput.value;
            
            if (type === 'trip') {
                const currencyFields = ['cuocXe', 'chiPhiXangDau', 'chiPhiVe', 'chiPhiLuong', 'chiPhiCaXe', 'chiPhiPhatSinh'];
                currencyFields.forEach(field => {
                    data[field] = parseFloat(data[field]) || 0;
                });
            }

            const collections = { trip: tripsCol, customer: customersCol, driver: driversCol, tractor: tractorsCol, trailer: trailersCol };
            const collectionRef = collections[type];

            try {
                if (id) { await setDoc(doc(collectionRef, id), data, { merge: true }); } 
                else { await addDoc(collectionRef, data); }
                closeModal();
            } catch (error) {
                console.error("Error saving document: ", error);
                alert("Đã xảy ra lỗi khi lưu.");
            }
        });

        document.querySelector('main').addEventListener('click', async e => {
            const target = e.target.closest('button.edit-btn, button.delete-btn');
            if (!target) return;

            const { id, type } = target.dataset;
            const collections = { trip: tripsCol, customer: customersCol, driver: driversCol, tractor: tractorsCol, trailer: trailersCol };
            const collectionRef = collections[type];

            if (target.classList.contains('edit-btn')) {
                const docRef = doc(collectionRef, id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    openModal(type, true, { id: docSnap.id, ...docSnap.data() });
                }
            } else if (target.classList.contains('delete-btn')) {
                const confirmed = await showConfirmDialog();
                if (confirmed) {
                    try { await deleteDoc(doc(collectionRef, id)); } 
                    catch (error) { console.error("Error deleting document: ", error); alert("Lỗi khi xóa."); }
                }
            }
        });

        // Search Listeners
        ['trips', 'customers', 'drivers', 'tractors', 'trailers'].forEach(type => {
            const searchInput = document.getElementById(`search-${type}`);
            if (!searchInput) return;
            searchInput.addEventListener('input', () => {
                switch(type) {
                    case 'trips': renderTable(document.getElementById('trips-table-body'), allTrips, createTripRow, searchInput.value); break;
                    case 'customers': renderTable(document.getElementById('customers-table-body'), allCustomers, (item, i) => createRow(item, i, 'customer'), searchInput.value); break;
                    case 'drivers': renderTable(document.getElementById('drivers-table-body'), allDrivers, (item, i) => createRow(item, i, 'driver'), searchInput.value); break;
                    case 'tractors': renderTable(document.getElementById('tractors-table-body'), allTractors, (item, i) => createRow(item, i, 'tractor'), searchInput.value); break;
                    case 'trailers': renderTable(document.getElementById('trailers-table-body'), allTrailers, (item, i) => createRow(item, i, 'trailer'), searchInput.value); break;
                }
            });
        });

        // --- Auth Management ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                userIdSpan.textContent = user.isAnonymous ? 'Shared Account' : user.uid;
                setupFirestoreListeners(); 
            } else {
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                });
            }
        });
    </script>
</body>
</html>
